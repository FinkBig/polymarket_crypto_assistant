<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Crypto Assistant</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --green: #3fb950;
            --green-bg: rgba(63, 185, 80, 0.15);
            --red: #f85149;
            --red-bg: rgba(248, 81, 73, 0.15);
            --yellow: #d29922;
            --yellow-bg: rgba(210, 153, 34, 0.15);
            --blue: #58a6ff;
            --cyan: #39c5cf;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 span {
            color: var(--text-secondary);
            font-weight: 400;
            font-size: 14px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .status-dot.disconnected {
            background: var(--red);
        }

        .status-dot.connecting {
            background: var(--yellow);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .tabs {
            display: flex;
            gap: 4px;
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 8px 20px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .main {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 1400px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title a {
            color: var(--text-primary);
            text-decoration: none;
            transition: color 0.15s ease;
        }

        .panel-title a:hover {
            color: var(--blue);
        }

        .panel-title a::after {
            content: ' ↗';
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .panel-title a:hover::after {
            opacity: 0.7;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.bullish {
            background: var(--green-bg);
            color: var(--green);
        }

        .badge.bearish {
            background: var(--red-bg);
            color: var(--red);
        }

        .badge.neutral {
            background: var(--yellow-bg);
            color: var(--yellow);
        }

        .score {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .panel-body {
            padding: 16px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .price {
            font-size: 24px;
            font-weight: 600;
        }

        .pm-odds {
            text-align: right;
            font-size: 13px;
        }

        .pm-odds .label {
            color: var(--text-muted);
            font-size: 11px;
        }

        .pm-up { color: var(--green); }
        .pm-dn { color: var(--red); }

        .indicators {
            display: grid;
            gap: 10px;
        }

        .indicator-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .indicator-label {
            color: var(--text-secondary);
        }

        .indicator-value {
            font-weight: 500;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Consolas', monospace;
        }

        .indicator-value.positive { color: var(--green); }
        .indicator-value.negative { color: var(--red); }
        .indicator-value.neutral { color: var(--yellow); }
        .indicator-value.muted { color: var(--text-muted); }

        .signal-tag {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .signal-tag.bullish {
            background: var(--green-bg);
            color: var(--green);
        }

        .signal-tag.bearish {
            background: var(--red-bg);
            color: var(--red);
        }

        .score-bar {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .score-bar-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .score-bar-track {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .score-bar-fill.positive { background: var(--green); }
        .score-bar-fill.negative { background: var(--red); }
        .score-bar-fill.neutral { background: var(--yellow); }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-muted);
            font-size: 14px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ha-candles {
            display: flex;
            gap: 3px;
            margin-top: 4px;
        }

        .ha-candle {
            width: 8px;
            height: 12px;
            border-radius: 2px;
        }

        .ha-candle.green { background: var(--green); }
        .ha-candle.red { background: var(--red); }

        .walls-info {
            display: flex;
            gap: 12px;
        }

        .wall-count {
            font-size: 12px;
        }

        .wall-count.buy { color: var(--green); }
        .wall-count.sell { color: var(--red); }

        .recommendation {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .recommendation.buy-yes {
            background: var(--green-bg);
            border-color: var(--green);
        }

        .recommendation.buy-no {
            background: var(--red-bg);
            border-color: var(--red);
        }

        .recommendation.wait {
            background: var(--bg-tertiary);
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .recommendation-action {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recommendation.buy-yes .recommendation-action { color: var(--green); }
        .recommendation.buy-no .recommendation-action { color: var(--red); }
        .recommendation.wait .recommendation-action { color: var(--text-muted); }

        .recommendation-confidence {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .recommendation-confidence.high {
            background: var(--green);
            color: var(--bg-primary);
        }

        .recommendation-confidence.medium {
            background: var(--yellow);
            color: var(--bg-primary);
        }

        .recommendation-reason {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .recommendation.buy-yes .recommendation-reason,
        .recommendation.buy-no .recommendation-reason {
            color: var(--text-primary);
        }

        .market-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .strike-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .strike-label {
            color: var(--text-muted);
        }

        .strike-price {
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .price-vs-strike {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 6px;
        }

        .price-vs-strike.above {
            background: var(--green-bg);
            color: var(--green);
        }

        .price-vs-strike.below {
            background: var(--red-bg);
            color: var(--red);
        }

        .time-remaining {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .time-remaining .label {
            color: var(--text-muted);
        }

        .time-remaining .value {
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .time-remaining.urgent .value {
            color: var(--red);
            animation: pulse 1s ease-in-out infinite;
        }

        .time-remaining.warning .value {
            color: var(--yellow);
        }

        /* ── Stats / Backtest tabs ─────────────────────── */
        .stats-view { display: none; }
        .stats-view.active { display: block; }
        .backtest-view { display: none; }
        .backtest-view.active { display: block; }
        .grid-view { display: block; }
        .grid-view.hidden { display: none; }

        /* ── Backtest-specific styles ─────────────────── */
        .equity-chart-wrap {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .equity-chart-wrap h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .equity-chart-wrap canvas {
            width: 100%;
            height: 250px;
            display: block;
        }

        .bt-detail-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .bt-detail-table td {
            padding: 8px 14px;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
        }

        .bt-detail-table td:first-child {
            color: var(--text-secondary);
            width: 50%;
        }

        .bt-detail-table td:last-child {
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
            text-align: right;
        }

        .bt-detail-table tr:last-child td { border-bottom: none; }

        .stats-header {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .stats-header { grid-template-columns: repeat(2, 1fr); }
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .stat-card .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .stat-card .stat-value.positive { color: var(--green); }
        .stat-card .stat-value.negative { color: var(--red); }

        .stats-section {
            margin-bottom: 24px;
        }

        .stats-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .stats-table th,
        .stats-table td {
            padding: 10px 14px;
            text-align: left;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-table tr:last-child td { border-bottom: none; }

        .stats-table .win { color: var(--green); }
        .stats-table .loss { color: var(--red); }
        .stats-table .pending { color: var(--text-muted); }

        .stats-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .stats-filters select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 6px 12px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>
            Polymarket Crypto Assistant
            <span>@Fink_Big</span>
        </h1>
        <div class="status-indicator">
            <div class="status-dot connecting" id="statusDot"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </header>

    <nav class="tabs" id="tabs">
        <button class="tab active" data-coin="BTC">BTC</button>
        <button class="tab" data-coin="ETH">ETH</button>
        <button class="tab" data-coin="SOL">SOL</button>
        <button class="tab" data-coin="XRP">XRP</button>
        <button class="tab" data-view="stats" style="margin-left:auto">Stats</button>
        <button class="tab" data-view="backtest">Backtest</button>
    </nav>

    <main class="main">
        <div class="grid-view" id="gridView">
            <div class="grid" id="grid"></div>
        </div>
        <div class="stats-view" id="statsView"></div>
        <div class="backtest-view" id="backtestView"></div>
    </main>

    <script>
        const COINS = ['BTC', 'ETH', 'SOL', 'XRP'];
        const TIMEFRAMES = ['15m', '1h', '4h', 'daily'];

        let currentCoin = 'BTC';
        let data = {};
        let ws = null;
        let reconnectTimeout = null;

        function formatPrice(val, decimals = 2) {
            if (val == null) return '—';
            if (val >= 1e6) return `$${(val / 1e6).toFixed(2)}M`;
            return `$${val.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals })}`;
        }

        function formatNumber(val, decimals = 2) {
            if (val == null) return '—';
            return val.toFixed(decimals);
        }

        function getTrendClass(trend) {
            if (trend === 'BULLISH') return 'bullish';
            if (trend === 'BEARISH') return 'bearish';
            return 'neutral';
        }

        function getValueClass(val) {
            if (val == null) return 'muted';
            if (val > 0) return 'positive';
            if (val < 0) return 'negative';
            return 'neutral';
        }

        function formatTimeRemaining(seconds) {
            if (seconds == null) return '—';
            if (seconds < 0) return 'Expired';
            if (seconds < 60) return `${Math.floor(seconds)}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.floor(seconds % 60)}s`;
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${mins}m`;
        }

        function getTimeClass(seconds) {
            if (seconds == null) return '';
            if (seconds < 120) return 'urgent';
            if (seconds < 300) return 'warning';
            return '';
        }

        function renderMarketInfo(item) {
            const strike = item.strike;
            const timeRemaining = item.time_remaining;
            const price = item.price;

            if (strike == null && timeRemaining == null) return '';

            let priceVsStrike = '';
            if (strike != null && price != null) {
                const diff = ((price - strike) / strike * 100).toFixed(2);
                const isAbove = price >= strike;
                priceVsStrike = `<span class="price-vs-strike ${isAbove ? 'above' : 'below'}">${isAbove ? '+' : ''}${diff}%</span>`;
            }

            const timeClass = getTimeClass(timeRemaining);

            return `
                <div class="market-info">
                    <div class="strike-info">
                        <span class="strike-label">Strike:</span>
                        <span class="strike-price">${strike != null ? formatPrice(strike) : '—'}</span>
                        ${priceVsStrike}
                    </div>
                    <div class="time-remaining ${timeClass}">
                        <span class="label">Expires:</span>
                        <span class="value">${formatTimeRemaining(timeRemaining)}</span>
                    </div>
                </div>
            `;
        }

        function renderRecommendation(rec) {
            if (!rec) return '';

            const actionClass = rec.action === 'BUY_YES' ? 'buy-yes' : rec.action === 'BUY_NO' ? 'buy-no' : 'wait';
            const actionText = rec.action === 'BUY_YES' ? 'Buy Yes' : rec.action === 'BUY_NO' ? 'Buy No' : 'Wait';

            return `
                <div class="recommendation ${actionClass}">
                    <div class="recommendation-header">
                        <span class="recommendation-action">${actionText}</span>
                        ${rec.confidence ? `<span class="recommendation-confidence ${rec.confidence.toLowerCase()}">${rec.confidence}</span>` : ''}
                    </div>
                    <div class="recommendation-reason">${rec.reason || ''}</div>
                </div>
            `;
        }

        function renderPanel(item) {
            if (item.loading) {
                return `
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">${item.timeframe}</div>
                        </div>
                        <div class="panel-body">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading data...
                            </div>
                        </div>
                    </div>
                `;
            }

            const ind = item.indicators || {};
            const trendClass = getTrendClass(item.trend);
            const scorePercent = Math.min(Math.abs(item.score || 0), 10) / 10 * 100;
            const scoreClass = item.score > 0 ? 'positive' : item.score < 0 ? 'negative' : 'neutral';

            return `
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            ${item.market_url ? `<a href="${item.market_url}" target="_blank" rel="noopener">${item.timeframe}</a>` : item.timeframe}
                            <span class="badge ${trendClass}">${item.trend || 'NEUTRAL'}</span>
                        </div>
                        <span class="score">${item.score >= 0 ? '+' : ''}${item.score || 0}</span>
                    </div>
                    <div class="panel-body">
                        <div class="price-row">
                            <div class="price">${formatPrice(item.price)}</div>
                            <div class="pm-odds">
                                <div class="label">Polymarket</div>
                                <span class="pm-up">${item.pm_up != null ? item.pm_up.toFixed(3) : '—'}</span>
                                <span class="pm-dn">${item.pm_dn != null ? item.pm_dn.toFixed(3) : '—'}</span>
                            </div>
                        </div>
                        ${renderMarketInfo(item)}
                        <div class="indicators">
                            <div class="indicator-row">
                                <span class="indicator-label">OBI</span>
                                <span class="indicator-value ${getValueClass(ind.obi)}">
                                    ${ind.obi != null ? (ind.obi * 100).toFixed(1) + '%' : '—'}
                                    ${ind.obi_signal && ind.obi_signal !== 'NEUTRAL' ? `<span class="signal-tag ${ind.obi_signal.toLowerCase()}">${ind.obi_signal}</span>` : ''}
                                </span>
                            </div>
                            <div class="indicator-row">
                                <span class="indicator-label">RSI(14)</span>
                                <span class="indicator-value ${ind.rsi_signal === 'OVERBOUGHT' ? 'negative' : ind.rsi_signal === 'OVERSOLD' ? 'positive' : 'muted'}">
                                    ${formatNumber(ind.rsi, 1)}
                                    ${ind.rsi_signal ? `<span class="signal-tag ${ind.rsi_signal === 'OVERSOLD' ? 'bullish' : 'bearish'}">${ind.rsi_signal}</span>` : ''}
                                </span>
                            </div>
                            <div class="indicator-row">
                                <span class="indicator-label">MACD</span>
                                <span class="indicator-value ${getValueClass(ind.macd_hist)}">
                                    ${ind.macd_cross ? `<span class="signal-tag ${ind.macd_cross}">${ind.macd_cross}</span>` : '—'}
                                </span>
                            </div>
                            <div class="indicator-row">
                                <span class="indicator-label">EMA Cross</span>
                                <span class="indicator-value ${ind.ema_cross === 'golden' ? 'positive' : ind.ema_cross === 'death' ? 'negative' : 'muted'}">
                                    ${ind.ema_cross ? `<span class="signal-tag ${ind.ema_cross === 'golden' ? 'bullish' : 'bearish'}">${ind.ema_cross}</span>` : '—'}
                                </span>
                            </div>
                            <div class="indicator-row">
                                <span class="indicator-label">VWAP</span>
                                <span class="indicator-value ${ind.vwap_signal === 'above' ? 'positive' : ind.vwap_signal === 'below' ? 'negative' : 'muted'}">
                                    ${formatPrice(ind.vwap)}
                                    ${ind.vwap_signal ? `<span class="signal-tag ${ind.vwap_signal === 'above' ? 'bullish' : 'bearish'}">${ind.vwap_signal}</span>` : ''}
                                </span>
                            </div>
                            <div class="indicator-row">
                                <span class="indicator-label">CVD 5m</span>
                                <span class="indicator-value ${getValueClass(ind.cvd_5m)}">
                                    ${formatPrice(ind.cvd_5m)}
                                </span>
                            </div>
                            <div class="indicator-row">
                                <span class="indicator-label">Walls</span>
                                <span class="walls-info">
                                    <span class="wall-count buy">${ind.buy_walls || 0} buy</span>
                                    <span class="wall-count sell">${ind.sell_walls || 0} sell</span>
                                </span>
                            </div>
                            ${ind.ha_last && ind.ha_last.length > 0 ? `
                            <div class="indicator-row">
                                <span class="indicator-label">Heikin Ashi</span>
                                <div class="ha-candles">
                                    ${ind.ha_last.map(green => `<div class="ha-candle ${green ? 'green' : 'red'}"></div>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="score-bar">
                            <div class="score-bar-label">
                                <span>Trend Score</span>
                                <span>${item.score >= 0 ? '+' : ''}${item.score || 0}</span>
                            </div>
                            <div class="score-bar-track">
                                <div class="score-bar-fill ${scoreClass}" style="width: ${scorePercent}%"></div>
                            </div>
                        </div>
                        ${renderRecommendation(item.recommendation)}
                    </div>
                </div>
            `;
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            const coinData = data[currentCoin] || [];

            if (coinData.length === 0) {
                grid.innerHTML = TIMEFRAMES.map(tf => `
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">${tf}</div>
                        </div>
                        <div class="panel-body">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading data...
                            </div>
                        </div>
                    </div>
                `).join('');
                return;
            }

            grid.innerHTML = coinData.map(item => renderPanel(item)).join('');
        }

        function setStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            dot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        function connect() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }

            setStatus('connecting', 'Connecting...');

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                setStatus('', 'Connected');
            };

            ws.onmessage = (event) => {
                try {
                    data = JSON.parse(event.data);
                    renderGrid();
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };

            ws.onclose = () => {
                setStatus('disconnected', 'Disconnected');
                reconnectTimeout = setTimeout(connect, 3000);
            };

            ws.onerror = () => {
                ws.close();
            };
        }

        // ── Stats tab ────────────────────────────────────────
        let statsView = 'grid'; // 'grid' or 'stats'
        let statsFilterCoin = '';
        let statsFilterTf = '';
        let statsFilterConf = '';

        function formatPct(val) {
            if (val == null) return '—';
            return (val * 100).toFixed(1) + '%';
        }

        function formatRoi(val) {
            if (val == null) return '—';
            const pct = (val * 100).toFixed(1) + '%';
            return val >= 0 ? '+' + pct : pct;
        }

        function roiClass(val) {
            if (val == null) return '';
            return val >= 0 ? 'positive' : 'negative';
        }

        function renderBreakdownTable(rows, labelKey) {
            if (!rows || rows.length === 0) return '<p style="color:var(--text-muted);font-size:13px">No data</p>';
            return `<table class="stats-table">
                <thead><tr>
                    <th>${labelKey}</th><th>Total</th><th>Wins</th><th>Win Rate</th><th>Avg ROI</th>
                </tr></thead>
                <tbody>${rows.map(r => {
                    const wr = r.total ? (r.wins / r.total * 100).toFixed(1) + '%' : '—';
                    return `<tr>
                        <td>${r[labelKey] || '—'}</td>
                        <td>${r.total}</td>
                        <td>${r.wins}</td>
                        <td>${wr}</td>
                        <td class="${roiClass(r.avg_roi)}">${formatRoi(r.avg_roi)}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
        }

        function renderSignalsTable(signals) {
            if (!signals || signals.length === 0) return '<p style="color:var(--text-muted);font-size:13px">No signals recorded yet</p>';
            return `<table class="stats-table">
                <thead><tr>
                    <th>Time</th><th>Coin</th><th>TF</th><th>Action</th><th>Conf</th><th>Price</th><th>Result</th><th>ROI</th>
                </tr></thead>
                <tbody>${signals.map(s => {
                    const dt = new Date(s.signal_time * 1000);
                    const time = dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                    const resultClass = s.result === 'WIN' ? 'win' : s.result === 'LOSS' ? 'loss' : 'pending';
                    return `<tr>
                        <td>${time}</td>
                        <td>${s.coin}</td>
                        <td>${s.timeframe}</td>
                        <td><span class="badge ${s.action === 'BUY_YES' ? 'bullish' : 'bearish'}">${s.action}</span></td>
                        <td>${s.confidence || '—'}</td>
                        <td>${s.entry_pm_price != null ? s.entry_pm_price.toFixed(3) : '—'}</td>
                        <td class="${resultClass}">${s.result || 'PENDING'}</td>
                        <td class="${roiClass(s.roi)}">${formatRoi(s.roi)}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
        }

        async function loadStats() {
            const params = new URLSearchParams();
            if (statsFilterCoin) params.set('coin', statsFilterCoin);
            if (statsFilterTf) params.set('timeframe', statsFilterTf);
            if (statsFilterConf) params.set('confidence', statsFilterConf);

            try {
                const [statsRes, signalsRes] = await Promise.all([
                    fetch('/api/stats?' + params),
                    fetch('/api/signals?' + params + '&limit=50'),
                ]);
                const stats = await statsRes.json();
                const signals = await signalsRes.json();
                renderStatsView(stats, signals);
            } catch (e) {
                document.getElementById('statsView').innerHTML =
                    '<p style="color:var(--red);padding:24px">Failed to load stats</p>';
            }
        }

        function renderStatsView(stats, signals) {
            const el = document.getElementById('statsView');
            const wrClass = stats.win_rate != null ? (stats.win_rate >= 0.5 ? 'positive' : 'negative') : '';
            const roiC = stats.avg_roi != null ? (stats.avg_roi >= 0 ? 'positive' : 'negative') : '';

            el.innerHTML = `
                <div class="stats-filters">
                    <select id="statsCoin" onchange="statsFilterCoin=this.value;loadStats()">
                        <option value="">All Coins</option>
                        ${['BTC','ETH','SOL','XRP'].map(c => `<option value="${c}" ${statsFilterCoin===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                    <select id="statsTf" onchange="statsFilterTf=this.value;loadStats()">
                        <option value="">All Timeframes</option>
                        ${['15m','1h','4h','daily'].map(t => `<option value="${t}" ${statsFilterTf===t?'selected':''}>${t}</option>`).join('')}
                    </select>
                    <select id="statsConf" onchange="statsFilterConf=this.value;loadStats()">
                        <option value="">All Confidence</option>
                        ${['HIGH','MEDIUM'].map(c => `<option value="${c}" ${statsFilterConf===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                </div>

                <div class="stats-header">
                    <div class="stat-card">
                        <div class="stat-value ${wrClass}">${stats.win_rate != null ? formatPct(stats.win_rate) : '—'}</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Resolved Signals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value ${roiC}">${stats.avg_roi != null ? formatRoi(stats.avg_roi) : '—'}</div>
                        <div class="stat-label">Avg ROI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:var(--yellow)">${stats.pending}</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>

                <div class="stats-section">
                    <h3>By Coin</h3>
                    ${renderBreakdownTable(stats.by_coin, 'coin')}
                </div>
                <div class="stats-section">
                    <h3>By Timeframe</h3>
                    ${renderBreakdownTable(stats.by_timeframe, 'timeframe')}
                </div>
                <div class="stats-section">
                    <h3>By Confidence</h3>
                    ${renderBreakdownTable(stats.by_confidence, 'confidence')}
                </div>

                <div class="stats-section">
                    <h3>Recent Signals</h3>
                    ${renderSignalsTable(signals)}
                </div>
            `;
        }

        function switchView(view) {
            statsView = view;
            document.getElementById('gridView').classList.toggle('hidden', view !== 'grid');
            document.getElementById('statsView').classList.toggle('active', view === 'stats');
            document.getElementById('backtestView').classList.toggle('active', view === 'backtest');
            if (view === 'stats') loadStats();
            if (view === 'backtest') loadBacktest();
        }

        document.getElementById('tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab')) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');

                if (e.target.dataset.view === 'stats') {
                    switchView('stats');
                } else if (e.target.dataset.view === 'backtest') {
                    switchView('backtest');
                } else if (e.target.dataset.coin) {
                    currentCoin = e.target.dataset.coin;
                    switchView('grid');
                    renderGrid();
                }
            }
        });

        // ── Backtest tab ─────────────────────────────────────
        let btFilterCoin = '';
        let btFilterTf = '';
        let btFilterConf = '';

        async function loadBacktest() {
            const params = new URLSearchParams();
            if (btFilterCoin) params.set('coin', btFilterCoin);
            if (btFilterTf) params.set('timeframe', btFilterTf);
            if (btFilterConf) params.set('confidence', btFilterConf);

            try {
                const res = await fetch('/api/backtest?' + params);
                const json = await res.json();
                renderBacktestView(json.stats, json.trades);
            } catch (e) {
                document.getElementById('backtestView').innerHTML =
                    '<p style="color:var(--red);padding:24px">Failed to load backtest data</p>';
            }
        }

        function renderBacktestView(stats, trades) {
            const el = document.getElementById('backtestView');
            const pnlClass = stats.total_pnl >= 0 ? 'positive' : 'negative';
            const wrClass = stats.win_rate != null ? (stats.win_rate >= 0.5 ? 'positive' : 'negative') : '';

            // Build cumulative PnL for trade log
            let cum = 0;
            const tradesWithCum = trades.map(t => {
                cum += (t.roi || 0);
                return { ...t, cum_pnl: cum };
            });

            el.innerHTML = `
                <div class="stats-filters">
                    <select onchange="btFilterCoin=this.value;loadBacktest()">
                        <option value="">All Coins</option>
                        ${['BTC','ETH','SOL','XRP'].map(c => `<option value="${c}" ${btFilterCoin===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                    <select onchange="btFilterTf=this.value;loadBacktest()">
                        <option value="">All Timeframes</option>
                        ${['15m','1h','4h','daily'].map(t => `<option value="${t}" ${btFilterTf===t?'selected':''}>${t}</option>`).join('')}
                    </select>
                    <select onchange="btFilterConf=this.value;loadBacktest()">
                        <option value="">All Confidence</option>
                        ${['HIGH','MEDIUM'].map(c => `<option value="${c}" ${btFilterConf===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                </div>

                <div class="equity-chart-wrap">
                    <h3>Equity Curve ($1 per trade)</h3>
                    <canvas id="equityCanvas" height="250"></canvas>
                </div>

                <div class="stats-header">
                    <div class="stat-card">
                        <div class="stat-value ${pnlClass}">${stats.total_pnl != null ? (stats.total_pnl >= 0 ? '+' : '') + '$' + Math.abs(stats.total_pnl).toFixed(2) : '—'}</div>
                        <div class="stat-label">Total PnL</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value ${wrClass}">${stats.win_rate != null ? formatPct(stats.win_rate) : '—'}</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.profit_factor != null ? stats.profit_factor.toFixed(2) : '—'}</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value negative">${stats.max_drawdown != null ? '-$' + stats.max_drawdown.toFixed(2) : '—'}</div>
                        <div class="stat-label">Max Drawdown</div>
                    </div>
                </div>

                <div class="stats-section">
                    <h3>Detailed Stats</h3>
                    <table class="bt-detail-table">
                        <tr><td>Total Trades</td><td>${stats.total}</td></tr>
                        <tr><td>Wins / Losses</td><td><span style="color:var(--green)">${stats.wins}</span> / <span style="color:var(--red)">${stats.losses}</span></td></tr>
                        <tr><td>Avg Win</td><td class="${stats.avg_win != null && stats.avg_win >= 0 ? 'positive' : ''}" style="color:var(--green)">${stats.avg_win != null ? formatRoi(stats.avg_win) : '—'}</td></tr>
                        <tr><td>Avg Loss</td><td style="color:var(--red)">${stats.avg_loss != null ? formatRoi(stats.avg_loss) : '—'}</td></tr>
                        <tr><td>Best Trade</td><td style="color:var(--green)">${stats.best_trade != null ? formatRoi(stats.best_trade) : '—'}</td></tr>
                        <tr><td>Worst Trade</td><td style="color:var(--red)">${stats.worst_trade != null ? formatRoi(stats.worst_trade) : '—'}</td></tr>
                        <tr><td>Longest Win Streak</td><td>${stats.longest_win_streak}</td></tr>
                        <tr><td>Longest Loss Streak</td><td>${stats.longest_loss_streak}</td></tr>
                    </table>
                </div>

                <div class="stats-section">
                    <h3>Trade Log</h3>
                    ${renderTradeLogTable(tradesWithCum)}
                </div>
            `;

            drawEquityCurve(tradesWithCum);
        }

        function renderTradeLogTable(trades) {
            if (!trades || trades.length === 0) return '<p style="color:var(--text-muted);font-size:13px">No resolved trades yet</p>';
            return `<table class="stats-table">
                <thead><tr>
                    <th>Time</th><th>Coin</th><th>TF</th><th>Action</th><th>Entry</th><th>Result</th><th>ROI</th><th>Cum PnL</th>
                </tr></thead>
                <tbody>${trades.map(t => {
                    const dt = new Date(t.signal_time * 1000);
                    const time = dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                    const resultClass = t.result === 'WIN' ? 'win' : 'loss';
                    const cumClass = t.cum_pnl >= 0 ? 'positive' : 'negative';
                    return `<tr>
                        <td>${time}</td>
                        <td>${t.coin}</td>
                        <td>${t.timeframe}</td>
                        <td><span class="badge ${t.action === 'BUY_YES' ? 'bullish' : 'bearish'}">${t.action}</span></td>
                        <td>${t.entry_pm_price != null ? t.entry_pm_price.toFixed(3) : '—'}</td>
                        <td class="${resultClass}">${t.result}</td>
                        <td class="${roiClass(t.roi)}">${formatRoi(t.roi)}</td>
                        <td class="${cumClass}">${t.cum_pnl >= 0 ? '+' : ''}$${t.cum_pnl.toFixed(2)}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
        }

        function drawEquityCurve(trades) {
            const canvas = document.getElementById('equityCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const W = rect.width;
            const H = rect.height;

            ctx.clearRect(0, 0, W, H);

            if (!trades || trades.length === 0) {
                ctx.fillStyle = '#6e7681';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data', W / 2, H / 2);
                return;
            }

            // Build points: start at 0, then each trade's cum_pnl
            const points = [0, ...trades.map(t => t.cum_pnl)];
            const minY = Math.min(...points);
            const maxY = Math.max(...points);
            const rangeY = maxY - minY || 1;

            const padL = 55, padR = 16, padT = 16, padB = 30;
            const cW = W - padL - padR;
            const cH = H - padT - padB;

            // Grid lines
            ctx.strokeStyle = '#21262d';
            ctx.lineWidth = 1;
            const gridLines = 5;
            ctx.font = '11px SF Mono, Monaco, monospace';
            ctx.fillStyle = '#6e7681';
            ctx.textAlign = 'right';
            for (let i = 0; i <= gridLines; i++) {
                const y = padT + (cH / gridLines) * i;
                const val = maxY - (rangeY / gridLines) * i;
                ctx.beginPath();
                ctx.moveTo(padL, y);
                ctx.lineTo(W - padR, y);
                ctx.stroke();
                ctx.fillText('$' + val.toFixed(2), padL - 6, y + 4);
            }

            // Zero line
            if (minY < 0 && maxY > 0) {
                const zeroY = padT + cH * (maxY / rangeY);
                ctx.strokeStyle = '#30363d';
                ctx.lineWidth = 1.5;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(padL, zeroY);
                ctx.lineTo(W - padR, zeroY);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Draw line
            ctx.strokeStyle = points[points.length - 1] >= 0 ? '#3fb950' : '#f85149';
            ctx.lineWidth = 2;
            ctx.lineJoin = 'round';
            ctx.beginPath();
            for (let i = 0; i < points.length; i++) {
                const x = padL + (i / (points.length - 1)) * cW;
                const y = padT + cH * ((maxY - points[i]) / rangeY);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Fill under curve
            const lastX = padL + cW;
            const baseY = padT + cH * (maxY / rangeY);
            ctx.lineTo(lastX, baseY);
            ctx.lineTo(padL, baseY);
            ctx.closePath();
            const grad = ctx.createLinearGradient(0, padT, 0, H - padB);
            const color = points[points.length - 1] >= 0 ? '63,185,80' : '248,81,73';
            grad.addColorStop(0, `rgba(${color},0.25)`);
            grad.addColorStop(1, `rgba(${color},0.02)`);
            ctx.fillStyle = grad;
            ctx.fill();

            // X-axis labels (first, middle, last trade times)
            if (trades.length > 0) {
                ctx.fillStyle = '#6e7681';
                ctx.textAlign = 'center';
                ctx.font = '10px SF Mono, Monaco, monospace';
                const indices = [0, Math.floor(trades.length / 2), trades.length - 1];
                for (const idx of indices) {
                    const t = trades[idx];
                    const x = padL + ((idx + 1) / (points.length - 1)) * cW;
                    const dt = new Date(t.signal_time * 1000);
                    const label = (dt.getMonth()+1) + '/' + dt.getDate() + ' ' + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                    ctx.fillText(label, x, H - 6);
                }
            }
        }

        connect();
        renderGrid();
    </script>
</body>
</html>
